<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Up - Brightrose Tech</title>
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
 <script>
  // Supabase configuration
  const SUPABASE_URL = 'https://ekhanvqqylomkatamfqs.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVraGFudnFxeWxvbWthdGFtZnFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjQyMTQzNzMsImV4cCI6MjAzOTc5MDM3M30.Sb-ozUBDdM8j7Q31x36zGSHqHAnQpxil_NGcW_AdlHo';
  
  // Initialize Supabase
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // Debug logging
  function debugLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    console.log(`[${timestamp}] ${message}`);
    
    // Also show in debug panel
    const debugPanel = document.getElementById('debugPanel');
    if (debugPanel) {
      debugPanel.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }
    
    // Show notification for important messages
    if (type === 'error') {
      showNotification('Error', message, 'error');
    } else if (type === 'success') {
      showNotification('Success', message, 'success');
    }
  }
  
  // Toggle debug panel
  document.getElementById('debugToggle').addEventListener('click', function() {
    document.getElementById('debugPanel').classList.toggle('show');
  });
  
  // DOM Elements
  const signupForm = document.getElementById('signupForm');
  const profilePhoto = document.getElementById('profilePhoto');
  const profilePreview = document.getElementById('profilePreview');
  const removePhoto = document.getElementById('removePhoto');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const passwordMatchText = document.getElementById('passwordMatchText');
  const passwordStrength = document.getElementById('passwordStrength');
  const passwordStrengthText = document.getElementById('passwordStrengthText');
  const submitBtn = document.getElementById('submitBtn');
  const successMessage = document.getElementById('successMessage');
  const resendEmailBtn = document.getElementById('resendEmail');
  const returnToFormBtn = document.getElementById('returnToForm');
  
  // Profile picture handling
  let profileImageFile = null;
  
  profilePhoto.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.match('image.*')) {
      debugLog('Please select an image file (JPEG, PNG, etc.)', 'error');
      return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
      debugLog('Image must be less than 5MB', 'error');
      return;
    }
    
    profileImageFile = file;
    debugLog(`Profile image selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
    
    // Preview image
    const reader = new FileReader();
    reader.onload = function(e) {
      profilePreview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
    };
    reader.readAsDataURL(file);
  });
  
  removePhoto.addEventListener('click', function() {
    profilePhoto.value = '';
    profilePreview.innerHTML = '<div class="placeholder"><i class="fa-solid fa-user fa-2x"></i></div>';
    profileImageFile = null;
    debugLog('Profile image removed');
  });
  
  // Upload image to Supabase Storage
  async function uploadProfileImage(userId) {
    if (!profileImageFile) {
      debugLog('No profile image to upload');
      return null;
    }
    
    try {
      debugLog('Starting profile image upload...');
      
      const fileExt = profileImageFile.name.split('.').pop();
      const fileName = `${userId}-${Date.now()}.${fileExt}`;
      
      debugLog(`Uploading file: ${fileName}`);
      
      // Upload to Supabase Storage
      const { data, error } = await supabase.storage
        .from('user-profiles')
        .upload(fileName, profileImageFile, {
          cacheControl: '3600',
          upsert: false
        });
      
      if (error) {
        debugLog(`Upload failed: ${error.message}`);
        // Don't throw error - profile picture is optional
        return null;
      }
      
      // Get public URL
      const { data: { publicUrl } } = supabase.storage
        .from('user-profiles')
        .getPublicUrl(fileName);
      
      debugLog(`Upload successful: ${publicUrl}`);
      return publicUrl;
      
    } catch (error) {
      debugLog(`Upload error: ${error.message}`);
      return null;
    }
  }
  
  // Password strength checker
  passwordInput.addEventListener('input', function() {
    const password = passwordInput.value;
    let strength = 0;
    
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]+/)) strength++;
    if (password.match(/[A-Z]+/)) strength++;
    if (password.match(/[0-9]+/)) strength++;
    if (password.match(/[!@#$%^&*(),.?":{}|<>]+/)) strength++;
    
    // Update strength meter
    passwordStrength.className = 'password-strength';
    if (password.length === 0) {
      passwordStrengthText.textContent = 'Password strength';
      passwordStrengthText.style.color = '';
    } else if (strength <= 2) {
      passwordStrength.classList.add('weak');
      passwordStrengthText.textContent = 'Weak password';
      passwordStrengthText.style.color = 'var(--danger)';
    } else if (strength <= 4) {
      passwordStrength.classList.add('medium');
      passwordStrengthText.textContent = 'Medium strength password';
      passwordStrengthText.style.color = 'var(--warning)';
    } else {
      passwordStrength.classList.add('strong');
      passwordStrengthText.textContent = 'Strong password';
      passwordStrengthText.style.color = 'var(--success)';
    }
  });
  
  // Password confirmation check
  confirmPasswordInput.addEventListener('input', function() {
    if (confirmPasswordInput.value === '') {
      passwordMatchText.textContent = '';
    } else if (confirmPasswordInput.value !== passwordInput.value) {
      passwordMatchText.textContent = 'Passwords do not match';
      passwordMatchText.style.color = 'var(--danger)';
    } else {
      passwordMatchText.textContent = 'Passwords match';
      passwordMatchText.style.color = 'var(--success)';
    }
  });
  
  // SIMPLE SIGNUP FUNCTION - This is the key fix!
  async function signupUser(firstName, lastName, email, password, newsletter) {
    debugLog('Starting SIMPLE signup process...');
    
    try {
      // Step 1: Create auth user
      debugLog('1. Creating auth user...');
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          data: {
            first_name: firstName,
            last_name: lastName,
            newsletter: newsletter
          }
        }
      });
      
      if (authError) {
        debugLog(`Auth error: ${authError.message}`, 'error');
        throw authError;
      }
      
      if (!authData.user) {
        throw new Error('No user data returned from auth');
      }
      
      debugLog(`✅ Auth user created: ${authData.user.id}`);
      
      // Step 2: Upload profile image (optional)
      let profileImageUrl = null;
      if (profileImageFile && authData.user.id) {
        debugLog('2. Uploading profile image...');
        profileImageUrl = await uploadProfileImage(authData.user.id);
        debugLog(`Profile image: ${profileImageUrl || 'None'}`);
      }
      
      // Step 3: Insert into database
      debugLog('3. Inserting into brightrose_users...');
      
      const userData = {
        id: authData.user.id,
        first_name: firstName,
        last_name: lastName,
        email: email,
        profile_image: profileImageUrl,
        newsletter: newsletter,
        email_verified: false
        // created_at and updated_at will use DEFAULT values
      };
      
      debugLog('Inserting data:', JSON.stringify(userData));
      
      const { data: dbData, error: dbError } = await supabase
        .from('brightrose_users')
        .insert(userData)
        .select();
      
      if (dbError) {
        debugLog(`Database error: ${dbError.message}`, 'error');
        debugLog(`Error code: ${dbError.code}`, 'error');
        
        // If duplicate, just update
        if (dbError.code === '23505') {
          debugLog('User already exists in table, updating...');
          const { error: updateError } = await supabase
            .from('brightrose_users')
            .update(userData)
            .eq('id', authData.user.id);
          
          if (updateError) {
            throw updateError;
          }
          debugLog('✅ Updated existing record');
        } else {
          throw dbError;
        }
      } else {
        debugLog('✅ Database insert successful');
      }
      
      return {
        success: true,
        userId: authData.user.id,
        email: email
      };
      
    } catch (error) {
      debugLog(`Signup failed: ${error.message}`, 'error');
      throw error;
    }
  }
  
  // Form submission
  signupForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Basic validation
    if (passwordInput.value !== confirmPasswordInput.value) {
      debugLog('Passwords do not match', 'error');
      return;
    }
    
    if (passwordInput.value.length < 8) {
      debugLog('Password must be at least 8 characters long', 'error');
      return;
    }
    
    if (!document.getElementById('terms').checked) {
      debugLog('You must accept the Terms of Service', 'error');
      return;
    }
    
    // Get form values
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const password = passwordInput.value;
    const subscribeToNewsletter = document.getElementById('newsletter').checked;
    
    if (!firstName || !lastName || !email) {
      debugLog('Please fill in all required fields', 'error');
      return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      debugLog('Please enter a valid email address', 'error');
      return;
    }
    
    // Update button to show loading state
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner"></span> Creating account...';
    submitBtn.disabled = true;
    
    try {
      debugLog(`Starting signup for: ${email}`);
      
      const result = await signupUser(firstName, lastName, email, password, subscribeToNewsletter);
      
      if (result.success) {
        // SUCCESS: Show success message and hide form
        signupForm.style.display = 'none';
        successMessage.classList.add('show');
        
        debugLog('✅ Account created successfully!', 'success');
        
        // Store email for potential resend
        localStorage.setItem('lastSignupEmail', email);
      }
      
    } catch (error) {
      console.error('Signup Error:', error);
      
      // User-friendly error messages
      let errorMessage = 'An error occurred during signup. Please try again.';
      
      if (error.message.includes('User already registered')) {
        errorMessage = 'An account with this email already exists. Please sign in instead.';
      } else if (error.message.includes('already exists')) {
        errorMessage = 'This email is already registered. Please use a different email or try signing in.';
      } else if (error.message.includes('Password should be at least')) {
        errorMessage = 'Password is too weak. Please choose a stronger password.';
      } else if (error.message.includes('Invalid email')) {
        errorMessage = 'Invalid email address. Please check your email and try again.';
      } else if (error.message.includes('Email rate limit exceeded')) {
        errorMessage = 'Too many signup attempts. Please try again in a few minutes.';
      } else if (error.message.includes('does not exist')) {
        errorMessage = 'Database table not found. Please run the SQL setup first.';
      } else if (error.message.includes('permission denied')) {
        errorMessage = 'Permission denied. Please check RLS policies.';
      } else if (error.message.includes('23505')) {
        errorMessage = 'This email is already registered. Please sign in instead.';
      }
      
      debugLog(errorMessage, 'error');
      
      // Reset button state
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });
  
  // Resend verification email
  resendEmailBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    
    const email = localStorage.getItem('lastSignupEmail');
    if (!email) {
      debugLog('No email found. Please sign up again.', 'error');
      return;
    }
    
    try {
      const { error } = await supabase.auth.resend({
        type: 'signup',
        email: email
      });
      
      if (error) throw error;
      
      debugLog('Verification email resent! Check your inbox.', 'success');
    } catch (error) {
      console.error('Resend Error:', error);
      debugLog('Failed to resend verification email. Please try again later.', 'error');
    }
  });
  
  // Return to form button
  returnToFormBtn.addEventListener('click', function() {
    successMessage.classList.remove('show');
    signupForm.style.display = 'grid';
    signupForm.reset();
    
    // Reset profile picture
    profilePhoto.value = '';
    profilePreview.innerHTML = '<div class="placeholder"><i class="fa-solid fa-user fa-2x"></i></div>';
    profileImageFile = null;
    
    // Reset form validation
    passwordMatchText.textContent = '';
    passwordStrength.className = 'password-strength';
    passwordStrengthText.textContent = 'Password strength';
    passwordStrengthText.style.color = '';
    
    // Reset button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span>Create Account</span>';
  });
  
  // Notification system
  function showNotification(title, message, type = 'info') {
    const notificationContainer = document.getElementById('notificationContainer');
    
    // Remove old notifications if too many
    if (notificationContainer.children.length > 3) {
      notificationContainer.removeChild(notificationContainer.children[0]);
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    let icon = 'fa-info-circle';
    if (type === 'error') icon = 'fa-exclamation-circle';
    if (type === 'success') icon = 'fa-check-circle';
    if (type === 'warning') icon = 'fa-exclamation-triangle';
    if (type === 'info') icon = 'fa-info-circle';
    
    notification.innerHTML = `
      <div class="notification-icon">
        <i class="fa-solid ${icon}"></i>
      </div>
      <div class="notification-content">
        <h3 class="notification-title">${title}</h3>
        <p class="notification-message">${message}</p>
      </div>
      <button class="notification-close">
        <i class="fa-solid fa-times"></i>
      </button>
    `;
    
    notificationContainer.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    // Close notification on button click
    notification.querySelector('.notification-close').addEventListener('click', () => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 400);
    });
    
    // Auto-remove notification after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 400);
      }
    }, 5000);
  }
  
  // Test database connection on page load
  async function testDatabaseConnection() {
    try {
      debugLog('Testing database connection...');
      
      // Test if table exists
      const { data, error } = await supabase
        .from('brightrose_users')
        .select('count')
        .limit(1);
      
      if (error) {
        if (error.message.includes('does not exist')) {
          debugLog('❌ brightrose_users table does not exist!', 'error');
          debugLog('Please run the SQL setup script in Supabase SQL Editor:', 'error');
          debugLog('1. Go to Supabase Dashboard → SQL Editor', 'error');
          debugLog('2. Run the CREATE TABLE SQL script', 'error');
          debugLog('3. Refresh this page', 'error');
          return false;
        } else if (error.message.includes('permission denied')) {
          debugLog('❌ Permission denied. Check RLS policies.', 'error');
          return false;
        }
        debugLog(`❌ Database error: ${error.message}`, 'error');
        return false;
      }
      
      debugLog('✅ Database connection successful! Table exists.');
      return true;
      
    } catch (error) {
      debugLog(`❌ Database test failed: ${error.message}`, 'error');
      return false;
    }
  }
  
  // Initialize form validation
  function initializeFormValidation() {
    const inputs = signupForm.querySelectorAll('input[required]');
    inputs.forEach(input => {
      input.addEventListener('blur', function() {
        if (!this.value.trim()) {
          this.style.borderColor = 'var(--danger)';
        } else {
          this.style.borderColor = '';
        }
      });
      
      input.addEventListener('input', function() {
        if (this.value.trim()) {
          this.style.borderColor = '';
        }
      });
    });
  }
  
  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', async function() {
    debugLog('Page loaded');
    initializeFormValidation();
    
    // Test database connection
    const dbConnected = await testDatabaseConnection();
    
    if (!dbConnected) {
      debugLog('Signup will not work until database is set up.', 'error');
    } else {
      debugLog('Ready for signup!', 'success');
    }
    
    // Check if user is already logged in
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) {
        debugLog('You are already logged in. Redirecting to dashboard...', 'info');
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 2000);
      }
    });
    
    // Check for URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('verified') && urlParams.get('verified') === 'true') {
      debugLog('Email verified successfully! You can now sign in.', 'success');
    }
  });
</script>
</body>
</html>